name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-windows:
    name: Build and Test (Windows)
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Premake
      run: |
        powershell -ExecutionPolicy Bypass -File Scripts\Windows\install_premake_windows.ps1

    - name: Install Dependencies
      run: |
        # Ensure Git is available (should be on GitHub Actions runners)
        if (-not (Get-Command git -ErrorAction SilentlyContinue)) {
            Write-Host "Git not found. Installing Git..." -ForegroundColor Yellow
            winget install --id Git.Git -e --accept-source-agreements --accept-package-agreements
        }
        # Install vendor dependencies (spdlog, doctest, glm, json, SDL3)
        if (Test-Path "Scripts\Windows\install_deps_windows.ps1") {
            powershell -ExecutionPolicy Bypass -File Scripts\Windows\install_deps_windows.ps1
        } else {
            # Fallback: manually clone dependencies if install script doesn't exist
            $vendorDir = "Engine\Vendor"
            New-Item -ItemType Directory -Force -Path $vendorDir | Out-Null
            git clone --depth 1 https://github.com/gabime/spdlog.git "$vendorDir\spdlog"
            git clone --depth 1 https://github.com/doctest/doctest.git "$vendorDir\doctest"
            git clone --depth 1 https://github.com/g-truc/glm.git "$vendorDir\glm"
            git clone --depth 1 https://github.com/nlohmann/json.git "$vendorDir\json"
            # Build SDL3 to match the primary path behavior
            if (Test-Path "Scripts\Windows\build_sdl3_windows.ps1") {
                powershell -ExecutionPolicy Bypass -File Scripts\Windows\build_sdl3_windows.ps1
            }
        }

    - name: Generate project files
      run: Tools\Premake\premake5.exe vs2022

    - name: Find MSBuild
      id: msbuild
      run: |
        $msbuildPath = $null
        $vswhere = "${Env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
        if (Test-Path $vswhere) {
          $installPath = & $vswhere -latest -products * -requires Microsoft.Component.MSBuild -property installationPath
          if ($installPath) {
            $candidate = Join-Path $installPath "MSBuild\Current\Bin\MSBuild.exe"
            if (Test-Path $candidate) {
              $msbuildPath = $candidate
              echo "Found MSBuild at: $msbuildPath"
            }
          }
        }
        # Fallback: try to find msbuild in PATH
        if (-not $msbuildPath) {
          $msbuild = Get-Command msbuild.exe -ErrorAction SilentlyContinue
          if ($msbuild) {
            $msbuildPath = $msbuild.Source
            echo "Found MSBuild in PATH: $msbuildPath"
          }
        }
        # Set environment variable if found
        if ($msbuildPath) {
          echo "MSBUILD_PATH=$msbuildPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        } else {
          throw "MSBuild not found. Please ensure Visual Studio is installed."
        }

    - name: Build Engine
      run: |
        & "$env:MSBUILD_PATH" Build\Sabora.sln /p:Configuration=Debug /p:Platform=x64 /m /v:minimal

    - name: Build Tests
      run: |
        & "$env:MSBUILD_PATH" Build\Sabora.sln /p:Configuration=Debug /p:Platform=x64 /p:Project=Tests /m /v:minimal

    - name: Run Tests
      run: |
        Build\bin\Debug_x64\Tests\Tests.exe --success

  build-linux:
    name: Build and Test (Linux)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake git

    - name: Setup Premake
      run: |
        chmod +x Scripts/Linux/install_premake_linux.sh
        bash Scripts/Linux/install_premake_linux.sh

    - name: Build SDL3
      run: |
        if [ -f "Scripts/Linux/build_sdl3_linux.sh" ]; then
          chmod +x Scripts/Linux/build_sdl3_linux.sh
          bash Scripts/Linux/build_sdl3_linux.sh
        fi

    - name: Generate project files
      run: Tools/Premake/premake5 gmake2

    - name: Build Engine
      run: |
        cd Build
        make config=debug_x64 -j$(nproc)

    - name: Build Tests
      run: |
        cd Build
        make Tests config=debug_x64 -j$(nproc)

    - name: Run Tests
      run: |
        Build/bin/Debug_x64/Tests/Tests --success

  build-macos:
    name: Build and Test (macOS)
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        brew install cmake git

    - name: Setup Premake
      run: |
        chmod +x Scripts/macOS/install_premake_macos.sh
        bash Scripts/macOS/install_premake_macos.sh

    - name: Build SDL3
      run: |
        if [ -f "Scripts/macOS/build_sdl3_macos.sh" ]; then
          chmod +x Scripts/macOS/build_sdl3_macos.sh
          bash Scripts/macOS/build_sdl3_macos.sh
        fi

    - name: Generate project files
      run: Tools/Premake/premake5 gmake2

    - name: Build Engine
      run: |
        cd Build
        make config=debug_x64 -j$(sysctl -n hw.ncpu)

    - name: Build Tests
      run: |
        cd Build
        make Tests config=debug_x64 -j$(sysctl -n hw.ncpu)

    - name: Run Tests
      run: |
        Build/bin/Debug_x64/Tests/Tests --success

