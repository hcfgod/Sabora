name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-windows:
    name: Build and Test (Windows)
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Premake
      run: |
        powershell -ExecutionPolicy Bypass -File Scripts\Windows\install_premake_windows.ps1

    - name: Install Dependencies
      run: |
        # Ensure Git is available (should be on GitHub Actions runners)
        if (-not (Get-Command git -ErrorAction SilentlyContinue)) {
            Write-Host "Git not found. Installing Git..." -ForegroundColor Yellow
            winget install --id Git.Git -e --accept-source-agreements --accept-package-agreements
        }
        # Install vendor dependencies (spdlog, doctest, glm, json, SDL3)
        if (Test-Path "Scripts\Windows\install_deps_windows.ps1") {
            powershell -ExecutionPolicy Bypass -File Scripts\Windows\install_deps_windows.ps1
        } else {
            # Fallback: manually clone dependencies if install script doesn't exist
            $vendorDir = "Engine\Vendor"
            New-Item -ItemType Directory -Force -Path $vendorDir | Out-Null
            git clone --depth 1 https://github.com/gabime/spdlog.git "$vendorDir\spdlog"
            git clone --depth 1 https://github.com/doctest/doctest.git "$vendorDir\doctest"
            git clone --depth 1 https://github.com/g-truc/glm.git "$vendorDir\glm"
            git clone --depth 1 https://github.com/nlohmann/json.git "$vendorDir\json"
            # Build SDL3 to match the primary path behavior
            if (Test-Path "Scripts\Windows\build_sdl3_windows.ps1") {
                powershell -ExecutionPolicy Bypass -File Scripts\Windows\build_sdl3_windows.ps1
            }
        }

    - name: Generate project files
      run: Tools\Premake\premake5.exe vs2022

    - name: Find MSBuild
      id: msbuild
      run: |
        $msbuildPath = $null
        $vswhere = "${Env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
        if (Test-Path $vswhere) {
          $installPath = & $vswhere -latest -products * -requires Microsoft.Component.MSBuild -property installationPath
          if ($installPath) {
            $candidate = Join-Path $installPath "MSBuild\Current\Bin\MSBuild.exe"
            if (Test-Path $candidate) {
              $msbuildPath = $candidate
              echo "Found MSBuild at: $msbuildPath"
            }
          }
        }
        # Fallback: try to find msbuild in PATH
        if (-not $msbuildPath) {
          $msbuild = Get-Command msbuild.exe -ErrorAction SilentlyContinue
          if ($msbuild) {
            $msbuildPath = $msbuild.Source
            echo "Found MSBuild in PATH: $msbuildPath"
          }
        }
        # Set environment variable if found
        if ($msbuildPath) {
          echo "MSBUILD_PATH=$msbuildPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        } else {
          throw "MSBuild not found. Please ensure Visual Studio is installed."
        }

    - name: Build Engine
      run: |
        & "$env:MSBUILD_PATH" Build\Sabora.sln /p:Configuration=Debug /p:Platform=x64 /m /v:minimal

    - name: Verify SPIRV-Cross Build
      run: |
        Write-Host "Checking for SPIRV-Cross libraries..."
        $libDir = "Engine\Vendor\SPIRV-Cross\lib"
        if (Test-Path $libDir) {
          $libs = Get-ChildItem -Path $libDir -Filter "*.lib"
          if ($libs.Count -gt 0) {
            Write-Host "✓ SPIRV-Cross libraries found:"
            $libs | ForEach-Object { Write-Host "  - $($_.Name)" }
            # Verify we have both Debug and Release versions
            $hasDebug = $libs | Where-Object { $_.Name -like "*-debug.lib" }
            $hasRelease = $libs | Where-Object { $_.Name -like "*-release.lib" }
            if ($hasDebug -and $hasRelease) {
              Write-Host "✓ Both Debug and Release libraries found"
            } else {
              Write-Host "⚠ Warning: Missing Debug or Release libraries"
            }
          } else {
            Write-Host "✗ No SPIRV-Cross libraries found in $libDir"
            exit 1
          }
        } else {
          Write-Host "✗ SPIRV-Cross lib directory not found: $libDir"
          exit 1
        }

    - name: Verify New Libraries Build
      run: |
        Write-Host "Checking for msdf-atlas-gen, OpenAL Soft, libsndfile, libogg, libvorbis, and minimp3 libraries..."
        
        # Check msdf-atlas-gen
        $msdfLibDir = "Engine\Vendor\msdf-atlas-gen\lib"
        if (Test-Path $msdfLibDir) {
          $msdfLibs = Get-ChildItem -Path $msdfLibDir -Filter "*.lib" -ErrorAction SilentlyContinue
          if ($msdfLibs.Count -gt 0) {
            Write-Host "✓ msdf-atlas-gen libraries found ($($msdfLibs.Count) files)"
          } else {
            Write-Host "⚠ msdf-atlas-gen libraries not found (may be header-only)"
          }
        }
        
        # Check OpenAL Soft
        $openalLibDir = "Engine\Vendor\openal-soft\lib"
        if (Test-Path $openalLibDir) {
          $openalLibs = Get-ChildItem -Path $openalLibDir -Filter "*.lib" -ErrorAction SilentlyContinue
          if ($openalLibs.Count -gt 0) {
            Write-Host "✓ OpenAL Soft libraries found ($($openalLibs.Count) files)"
          } else {
            Write-Host "⚠ OpenAL Soft libraries not found"
          }
        }
        
        # Check libsndfile
        $libsndfileLibDir = "Engine\Vendor\libsndfile\lib"
        if (Test-Path $libsndfileLibDir) {
          $libsndfileLibs = Get-ChildItem -Path $libsndfileLibDir -Filter "*.lib" -ErrorAction SilentlyContinue
          if ($libsndfileLibs.Count -gt 0) {
            Write-Host "✓ libsndfile libraries found ($($libsndfileLibs.Count) files)"
          } else {
            Write-Host "⚠ libsndfile libraries not found"
          }
        }
        
        # Check libogg
        $liboggLibDir = "Engine\Vendor\libogg\lib"
        if (Test-Path $liboggLibDir) {
          $liboggLibs = Get-ChildItem -Path $liboggLibDir -Filter "*.lib" -ErrorAction SilentlyContinue
          if ($liboggLibs.Count -gt 0) {
            Write-Host "✓ libogg libraries found ($($liboggLibs.Count) files)"
          } else {
            Write-Host "⚠ libogg libraries not found"
          }
        }
        
        # Check libvorbis
        $libvorbisLibDir = "Engine\Vendor\libvorbis\lib"
        if (Test-Path $libvorbisLibDir) {
          $libvorbisLibs = Get-ChildItem -Path $libvorbisLibDir -Filter "*.lib" -ErrorAction SilentlyContinue
          if ($libvorbisLibs.Count -gt 0) {
            Write-Host "✓ libvorbis libraries found ($($libvorbisLibs.Count) files)"
          } else {
            Write-Host "⚠ libvorbis libraries not found"
          }
        }
        
        # Check minimp3 (header-only library)
        $minimp3Header = "Engine\Vendor\minimp3\minimp3.h"
        if (Test-Path $minimp3Header) {
          Write-Host "✓ minimp3 header found"
        } else {
          Write-Host "⚠ minimp3 header not found"
        }

    - name: Build Tests
      run: |
        & "$env:MSBUILD_PATH" Build\Sabora.sln /p:Configuration=Debug /p:Platform=x64 /p:Project=Tests /m /v:minimal

    - name: Run Tests
      run: |
        Build\bin\Debug_x64\Tests\Tests.exe --success

  build-linux:
    name: Build and Test (Linux)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake git python3

    - name: Setup Premake
      run: |
        chmod +x Scripts/Linux/install_premake_linux.sh
        bash Scripts/Linux/install_premake_linux.sh

    - name: Install Dependencies
      run: |
        # Install vendor dependencies (spdlog, doctest, glm, json, minimp3, SDL3)
        if [ -f "Scripts/Linux/install_deps_linux.sh" ]; then
          chmod +x Scripts/Linux/install_deps_linux.sh
          bash Scripts/Linux/install_deps_linux.sh
        else
          # Fallback: manually clone dependencies if install script doesn't exist
          VENDOR_DIR="Engine/Vendor"
          mkdir -p "$VENDOR_DIR"
          git clone --depth 1 https://github.com/gabime/spdlog.git "$VENDOR_DIR/spdlog"
          git clone --depth 1 https://github.com/doctest/doctest.git "$VENDOR_DIR/doctest"
          git clone --depth 1 https://github.com/g-truc/glm.git "$VENDOR_DIR/glm"
          git clone --depth 1 https://github.com/nlohmann/json.git "$VENDOR_DIR/json"
          git clone --depth 1 https://github.com/lieff/minimp3.git "$VENDOR_DIR/minimp3"
          # Note: SDL3 will be built in the next step
        fi

    - name: Verify SDL3 Build
      run: |
        echo "Checking for SDL3 library..."
        if [ -f "Engine/Vendor/SDL/lib/libSDL3.a" ]; then
          echo "✓ SDL3 library found: Engine/Vendor/SDL/lib/libSDL3.a"
          ls -lh Engine/Vendor/SDL/lib/libSDL3.a
        else
          echo "✗ SDL3 library NOT found at Engine/Vendor/SDL/lib/libSDL3.a"
          echo "Contents of Engine/Vendor/SDL/lib/:"
          ls -la Engine/Vendor/SDL/lib/ || echo "Directory does not exist"
          exit 1
        fi
        echo ""
        echo "Checking for required system libraries..."
        echo "Wayland libraries:"
        pkg-config --libs wayland-client wayland-egl wayland-cursor xkbcommon 2>/dev/null || echo "pkg-config not available or libraries not found"
        echo "PipeWire:"
        pkg-config --libs libpipewire-0.3 2>/dev/null || echo "pkg-config not available or library not found"
        echo "PulseAudio:"
        pkg-config --libs libpulse 2>/dev/null || echo "pkg-config not available or library not found"
        echo "ALSA:"
        pkg-config --libs alsa 2>/dev/null || echo "pkg-config not available or library not found"
        echo "libusb:"
        pkg-config --libs libusb-1.0 2>/dev/null || echo "pkg-config not available or library not found"
        echo "D-Bus:"
        pkg-config --libs dbus-1 2>/dev/null || echo "pkg-config not available or library not found"

    - name: Verify Shader Libraries Build
      run: |
        echo "Checking for shaderc library..."
        if [ -f "Engine/Vendor/shaderc/lib/libshaderc.a" ]; then
          echo "✓ shaderc library found: Engine/Vendor/shaderc/lib/libshaderc.a"
          ls -lh Engine/Vendor/shaderc/lib/libshaderc.a
        else
          echo "✗ shaderc library NOT found at Engine/Vendor/shaderc/lib/libshaderc.a"
          echo "Contents of Engine/Vendor/shaderc/lib/:"
          ls -la Engine/Vendor/shaderc/lib/ || echo "Directory does not exist"
          exit 1
        fi
        echo ""
        echo "Checking for SPIRV-Cross libraries..."
        LIB_DIR="Engine/Vendor/SPIRV-Cross/lib"
        if [ -d "$LIB_DIR" ]; then
          # Check for standard library names (for compatibility)
          if [ -f "$LIB_DIR/libspirv-cross-core.a" ]; then
            echo "✓ SPIRV-Cross libraries found (standard naming):"
            ls -lh "$LIB_DIR"/*.a | grep -v -- "-debug.a\|-release.a" || true
          fi
          # Check for Debug libraries
          DEBUG_COUNT=$(find "$LIB_DIR" -name "*-debug.a" | wc -l)
          if [ "$DEBUG_COUNT" -gt 0 ]; then
            echo "✓ SPIRV-Cross Debug libraries found ($DEBUG_COUNT files):"
            ls -lh "$LIB_DIR"/*-debug.a
          fi
          # Check for Release libraries
          RELEASE_COUNT=$(find "$LIB_DIR" -name "*-release.a" | wc -l)
          if [ "$RELEASE_COUNT" -gt 0 ]; then
            echo "✓ SPIRV-Cross Release libraries found ($RELEASE_COUNT files):"
            ls -lh "$LIB_DIR"/*-release.a
          fi
          # Verify we have at least some libraries
          TOTAL_COUNT=$(find "$LIB_DIR" -name "*.a" | wc -l)
          if [ "$TOTAL_COUNT" -eq 0 ]; then
            echo "✗ No SPIRV-Cross libraries found in $LIB_DIR"
            echo "Contents of $LIB_DIR/:"
            ls -la "$LIB_DIR/" || echo "Directory does not exist"
            exit 1
          else
            echo "✓ Total SPIRV-Cross libraries: $TOTAL_COUNT"
          fi
        else
          echo "✗ SPIRV-Cross lib directory not found: $LIB_DIR"
          exit 1
        fi

    - name: Verify New Libraries Build
      run: |
        echo "Checking for msdf-atlas-gen, OpenAL Soft, libsndfile, libogg, libvorbis, and minimp3 libraries..."
        
        # Check msdf-atlas-gen
        MSDF_LIB_DIR="Engine/Vendor/msdf-atlas-gen/lib"
        if [ -d "$MSDF_LIB_DIR" ]; then
          MSDF_COUNT=$(find "$MSDF_LIB_DIR" -name "*.a" | wc -l)
          if [ "$MSDF_COUNT" -gt 0 ]; then
            echo "✓ msdf-atlas-gen libraries found ($MSDF_COUNT files)"
          else
            echo "⚠ msdf-atlas-gen libraries not found (may be header-only)"
          fi
        fi
        
        # Check OpenAL Soft
        OPENAL_LIB_DIR="Engine/Vendor/openal-soft/lib"
        if [ -d "$OPENAL_LIB_DIR" ]; then
          OPENAL_COUNT=$(find "$OPENAL_LIB_DIR" -name "*.a" | wc -l)
          if [ "$OPENAL_COUNT" -gt 0 ]; then
            echo "✓ OpenAL Soft libraries found ($OPENAL_COUNT files)"
          else
            echo "⚠ OpenAL Soft libraries not found"
          fi
        fi
        
        # Check libsndfile
        LIBSNDFILE_LIB_DIR="Engine/Vendor/libsndfile/lib"
        if [ -d "$LIBSNDFILE_LIB_DIR" ]; then
          LIBSNDFILE_COUNT=$(find "$LIBSNDFILE_LIB_DIR" -name "*.a" | wc -l)
          if [ "$LIBSNDFILE_COUNT" -gt 0 ]; then
            echo "✓ libsndfile libraries found ($LIBSNDFILE_COUNT files)"
          else
            echo "⚠ libsndfile libraries not found"
          fi
        fi
        
        # Check libogg
        LIBOGG_LIB_DIR="Engine/Vendor/libogg/lib"
        if [ -d "$LIBOGG_LIB_DIR" ]; then
          LIBOGG_COUNT=$(find "$LIBOGG_LIB_DIR" -name "*.a" | wc -l)
          if [ "$LIBOGG_COUNT" -gt 0 ]; then
            echo "✓ libogg libraries found ($LIBOGG_COUNT files)"
          else
            echo "⚠ libogg libraries not found"
          fi
        fi
        
        # Check libvorbis
        LIBVORBIS_LIB_DIR="Engine/Vendor/libvorbis/lib"
        if [ -d "$LIBVORBIS_LIB_DIR" ]; then
          LIBVORBIS_COUNT=$(find "$LIBVORBIS_LIB_DIR" -name "*.a" | wc -l)
          if [ "$LIBVORBIS_COUNT" -gt 0 ]; then
            echo "✓ libvorbis libraries found ($LIBVORBIS_COUNT files)"
          else
            echo "⚠ libvorbis libraries not found"
          fi
        fi
        
        # Check minimp3 (header-only library)
        if [ -f "Engine/Vendor/minimp3/minimp3.h" ]; then
          echo "✓ minimp3 header found"
        else
          echo "⚠ minimp3 header not found"
        fi

    - name: Generate project files
      run: Tools/Premake/premake5 gmake2

    - name: Build Engine
      run: |
        cd Build
        make config=debug_x64 -j$(nproc)

    - name: Build Tests
      run: |
        cd Build
        make Tests config=debug_x64 -j$(nproc)

    - name: Run Tests
      run: |
        Build/bin/Debug_x64/Tests/Tests --success

  build-macos:
    name: Build and Test (macOS)
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        brew install cmake git python3 libusb

    - name: Setup Premake
      run: |
        chmod +x Scripts/macOS/install_premake_macos.sh
        bash Scripts/macOS/install_premake_macos.sh

    - name: Install Dependencies
      run: |
        # Install vendor dependencies (spdlog, doctest, glm, json, minimp3, SDL3)
        if [ -f "Scripts/macOS/install_deps_macos.sh" ]; then
          chmod +x Scripts/macOS/install_deps_macos.sh
          bash Scripts/macOS/install_deps_macos.sh
        else
          # Fallback: manually clone dependencies if install script doesn't exist
          VENDOR_DIR="Engine/Vendor"
          mkdir -p "$VENDOR_DIR"
          git clone --depth 1 https://github.com/gabime/spdlog.git "$VENDOR_DIR/spdlog"
          git clone --depth 1 https://github.com/doctest/doctest.git "$VENDOR_DIR/doctest"
          git clone --depth 1 https://github.com/g-truc/glm.git "$VENDOR_DIR/glm"
          git clone --depth 1 https://github.com/nlohmann/json.git "$VENDOR_DIR/json"
          git clone --depth 1 https://github.com/lieff/minimp3.git "$VENDOR_DIR/minimp3"
          # Note: SDL3 will be built in the next step
        fi

    - name: Verify Shader Libraries Build
      run: |
        echo "Checking for shaderc library..."
        if [ -f "Engine/Vendor/shaderc/lib/libshaderc.a" ]; then
          echo "✓ shaderc library found: Engine/Vendor/shaderc/lib/libshaderc.a"
          ls -lh Engine/Vendor/shaderc/lib/libshaderc.a
        else
          echo "✗ shaderc library NOT found at Engine/Vendor/shaderc/lib/libshaderc.a"
          echo "Contents of Engine/Vendor/shaderc/lib/:"
          ls -la Engine/Vendor/shaderc/lib/ || echo "Directory does not exist"
          exit 1
        fi
        echo ""
        echo "Checking for SPIRV-Cross libraries..."
        LIB_DIR="Engine/Vendor/SPIRV-Cross/lib"
        if [ -d "$LIB_DIR" ]; then
          # Check for standard library names (for compatibility)
          if [ -f "$LIB_DIR/libspirv-cross-core.a" ]; then
            echo "✓ SPIRV-Cross libraries found (standard naming):"
            ls -lh "$LIB_DIR"/*.a | grep -v -- "-debug.a\|-release.a" || true
          fi
          # Check for Debug libraries
          DEBUG_COUNT=$(find "$LIB_DIR" -name "*-debug.a" | wc -l)
          if [ "$DEBUG_COUNT" -gt 0 ]; then
            echo "✓ SPIRV-Cross Debug libraries found ($DEBUG_COUNT files):"
            ls -lh "$LIB_DIR"/*-debug.a
          fi
          # Check for Release libraries
          RELEASE_COUNT=$(find "$LIB_DIR" -name "*-release.a" | wc -l)
          if [ "$RELEASE_COUNT" -gt 0 ]; then
            echo "✓ SPIRV-Cross Release libraries found ($RELEASE_COUNT files):"
            ls -lh "$LIB_DIR"/*-release.a
          fi
          # Verify we have at least some libraries
          TOTAL_COUNT=$(find "$LIB_DIR" -name "*.a" | wc -l)
          if [ "$TOTAL_COUNT" -eq 0 ]; then
            echo "✗ No SPIRV-Cross libraries found in $LIB_DIR"
            echo "Contents of $LIB_DIR/:"
            ls -la "$LIB_DIR/" || echo "Directory does not exist"
            exit 1
          else
            echo "✓ Total SPIRV-Cross libraries: $TOTAL_COUNT"
          fi
        else
          echo "✗ SPIRV-Cross lib directory not found: $LIB_DIR"
          exit 1
        fi

    - name: Verify New Libraries Build
      run: |
        echo "Checking for msdf-atlas-gen, OpenAL Soft, libsndfile, libogg, libvorbis, and minimp3 libraries..."
        
        # Check msdf-atlas-gen
        MSDF_LIB_DIR="Engine/Vendor/msdf-atlas-gen/lib"
        if [ -d "$MSDF_LIB_DIR" ]; then
          MSDF_COUNT=$(find "$MSDF_LIB_DIR" -name "*.a" | wc -l)
          if [ "$MSDF_COUNT" -gt 0 ]; then
            echo "✓ msdf-atlas-gen libraries found ($MSDF_COUNT files)"
          else
            echo "⚠ msdf-atlas-gen libraries not found (may be header-only)"
          fi
        fi
        
        # Check OpenAL Soft
        OPENAL_LIB_DIR="Engine/Vendor/openal-soft/lib"
        if [ -d "$OPENAL_LIB_DIR" ]; then
          OPENAL_COUNT=$(find "$OPENAL_LIB_DIR" -name "*.a" | wc -l)
          if [ "$OPENAL_COUNT" -gt 0 ]; then
            echo "✓ OpenAL Soft libraries found ($OPENAL_COUNT files)"
          else
            echo "⚠ OpenAL Soft libraries not found"
          fi
        fi
        
        # Check libsndfile
        LIBSNDFILE_LIB_DIR="Engine/Vendor/libsndfile/lib"
        if [ -d "$LIBSNDFILE_LIB_DIR" ]; then
          LIBSNDFILE_COUNT=$(find "$LIBSNDFILE_LIB_DIR" -name "*.a" | wc -l)
          if [ "$LIBSNDFILE_COUNT" -gt 0 ]; then
            echo "✓ libsndfile libraries found ($LIBSNDFILE_COUNT files)"
          else
            echo "⚠ libsndfile libraries not found"
          fi
        fi
        
        # Check libogg
        LIBOGG_LIB_DIR="Engine/Vendor/libogg/lib"
        if [ -d "$LIBOGG_LIB_DIR" ]; then
          LIBOGG_COUNT=$(find "$LIBOGG_LIB_DIR" -name "*.a" | wc -l)
          if [ "$LIBOGG_COUNT" -gt 0 ]; then
            echo "✓ libogg libraries found ($LIBOGG_COUNT files)"
          else
            echo "⚠ libogg libraries not found"
          fi
        fi
        
        # Check libvorbis
        LIBVORBIS_LIB_DIR="Engine/Vendor/libvorbis/lib"
        if [ -d "$LIBVORBIS_LIB_DIR" ]; then
          LIBVORBIS_COUNT=$(find "$LIBVORBIS_LIB_DIR" -name "*.a" | wc -l)
          if [ "$LIBVORBIS_COUNT" -gt 0 ]; then
            echo "✓ libvorbis libraries found ($LIBVORBIS_COUNT files)"
          else
            echo "⚠ libvorbis libraries not found"
          fi
        fi
        
        # Check minimp3 (header-only library)
        if [ -f "Engine/Vendor/minimp3/minimp3.h" ]; then
          echo "✓ minimp3 header found"
        else
          echo "⚠ minimp3 header not found"
        fi

    - name: Generate project files
      run: Tools/Premake/premake5 gmake2

    - name: Build Engine
      run: |
        cd Build
        make config=debug_x64 -j$(sysctl -n hw.ncpu)

    - name: Build Tests
      run: |
        cd Build
        make Tests config=debug_x64 -j$(sysctl -n hw.ncpu)

    - name: Run Tests
      run: |
        Build/bin/Debug_x64/Tests/Tests --success

